<script src="/vendor/moment/moment.js"></script>
<script src="/vendor/moment/locale/fr.js"></script>

<h1><i class="fa fa-money"></i> <%- __('Cost calculator') %></h1>

<% if (filaments && filaments.length) { %>
<div class="row">
    <div class="col-md-6">
        <div class="panel panel-default filaments-list-container">
            <div class="panel-heading">
                <%- __('Filaments'); %><br/>
            </div>

            <table id="filament-list" class="table filament-list">
                <% filaments.forEach(function (filament) { %>
                <tr class="filament-item" id="filament-<%- filament._id %>" data-id="<%- filament._id %>" data-filament="<%= JSON.stringify(filament.getData(true)); %>" data-left-weight="<%= filament.leftMaterialWeight() %>" data-left-length="<%= filament.getLeftLength() %>">
                    <td>
                        <div class="color-preview-container">
                            <div title="<%- filament.color.name %>" class="color-preview"
                                 style="background-color: <%- filament.color.code %>;">
                                <div class="color-name"><%- filament.color.name %></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <%- filament.material.name %>
                        <br/>
                        <i class="p3di p3di-weight"></i>
                        <%- __('%s kg', filament.initialMaterialWeight) %>
                    </td>
                    <td>
                        <b>∅</b> <%- filament.diameter %>
                        <br/>
                        <%- __('%s kg/m³', filament.density) %>
                    </td>
                    <td>
                        <% if (filament.brand.logo && filament.brand.logo.size) { %>
                        <img alt="<%- filament.brand.name %>" title="<%- filament.brand.name %>" class="brand-logo"
                             src="/brand/get-logo/<%- filament.brand.id %>">
                        <% } else { %>
                        <%- filament.brand.name %>
                        <% } %>
                    </td>
                    <td>
                        <div class="progress">
                            <%
                                var leftPercentage = filament.materialLeftPercentage;
                                var progressbarClass = 'progress-bar-success';
                                if (leftPercentage <= config.get('filament:leftThresholds:warning')) {
                                    progressbarClass = 'progress-bar-warning'
                                }
                                if (leftPercentage <= config.get('filament:leftThresholds:danger')) {
                                    progressbarClass = 'progress-bar-danger'
                                }
                            %>
                            <div title="<%- leftPercentage %>%" class="progress-bar <%- progressbarClass %>"
                                 role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                                 style="width: <%- leftPercentage %>%;">
                                <% if (filament.materialLeftPercentage > 50) { %>
                                <%- sprintf('%.2f', leftPercentage) %>%
                                <% } %>
                            </div>
                            <% if (filament.materialLeftPercentage <= 50) { %>
                            <div class="progress-text" style="padding-left:<%- leftPercentage%>%"><%- sprintf('%.2f', leftPercentage) %>%</div>
                            <% } %>
                        </div>
                        <div class="filament-left-data">
                            <%- __('~ %.2f Kg / ~ %.2f m', filament.leftMaterialWeight(), filament.getLeftLength()) %>
                        </div>
                    </td>
                </tr>
                <% }); %>
            </table>
        </div>
    </div>


    <div id="compute-form" class="col-md-6" style="display:none;">
        <table class="table filament-list filament-details">
            <tr>
                <td>
                    <div class="color-preview-container">
                        <div title="" class="color-preview">
                            <div class="color-name"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="filament-material-name"></span>
                    <br/>
                    <i class="p3di p3di-weight"></i>
                    <span class="filament-weight"></span>
                </td>
                <td>
                    <b>∅</b> <span class="filament-diameter"></span>
                    <br/>
                    <span class="filament-density"></span>
                </td>
                <td class="filament-brand-logo">
                </td>
                <td>
                    <div class="progress">
                        <div title="" class="progress-bar"
                             role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                        </div>
                        <div class="progress-text">
                        </div>
                    </div>
                    <div class="filament-left-data"></div>
                </td>
            </tr>
            <tr>
                <td class="shop-data filament-shop-logo" colspan="3">
                </td>
                <td colspan="2">
                    <b><%- __('Purchased on:') %></b> <span class="filament-buy-date"></span>
                    <br/>
                    <b><%- __('Price:') %></b> <span class="filament-price"></span>
                </td>
            </tr>

        </table>

        <hr/>

        <form class="form-filament">
            <fieldset>
                <div class="row ">
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="weight"
                                   class="control-label"><i class="p3di p3di-weight"></i> <%- __('Weight:'); %></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="weight"
                                       name="weight">
                                <div class="input-group-addon">
                                    <label for="weight-unit-g"><input type="radio" name="weighUnit" value="g" id="weight-unit-g" <%- (locals.weighUnit) ? (weighUnit=='g'?'checked':'') : 'checked' %>> <%- __('g'); %></label>
                                    /
                                    <label for="weight-unit-kg"><input type="radio" name="weighUnit" value="kg" id="weight-unit-kg" <%- (locals.weighUnit) ? (weighUnit=='kg'?'checked':'') : '' %>> <%- __('Kg'); %></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 form-horizontal-alternative-or">
                        <div style="margin-top: 30px;"><%- __('or') %></div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="length"
                                   class="control-label"><i class="p3di p3di-ruler"></i> <%- __('Length:'); %></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="length"
                                       name="length">
                                <div class="input-group-addon"><%- __('m'); %></div>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
        </form>

        <div class="row" id="computed-filament-results">
            <div class="col-md-4"><i class="p3di p3di-weight"></i> <span id="computed-filament-weight"></span></div>
            <div class="col-md-4"><i class="p3di p3di-ruler"></i> <span id="computed-filament-length"></span></div>
            <div class="col-md-4"><i class="fa fa-money"></i> <span id="computed-filament-cost"></span></div>
        </div>

        </div>
    </div>
</div>
<% } %>

<script type="text/javascript">
function filamentComputeCostOnChange() {
    var filamentId = $('.filament-details').data('id');
    $.ajax({
        method: 'POST',
        url: '/filament/cost-calculator/'+filamentId,
        data: $('form.form-filament').serialize(),
        success: function(data) {
            if ((typeof data.weight !== "undefined" && data.weight !== null)
            || (typeof data.length !== "undefined" && data.length !== null)
            || (typeof data.cost !== "undefined" && data.cost !== null)) {
                if (typeof data.weight !== "undefined" && data.weight !== null) {
                    $('#computed-filament-weight').text(Locale3DPTools.__('%.3f Kg', data.weight))
                }
                if (typeof data.length !== "undefined" && data.length !== null) {
                    $('#computed-filament-length').text(Locale3DPTools.__('%.3f m', data.length))
                }
                if (typeof data.cost !== "undefined" && data.cost !== null) {
                    $('#computed-filament-cost').text(Locale3DPTools.__('%.3f €', data.cost))
                }
                $('#computed-filament-results').show();
            } else {
                $('#computed-filament-results').hide();
            }
        }
    });
}

$(function() {
    $('form.form-filament').submit(function(e) {
        e.preventDefault();
        filamentComputeCostOnChange();
        return false;
    });

    $('#length').keyup(function(e) {
        $('#weight').val('');
        filamentComputeCostOnChange();
    });
    $('#weight').keyup(function(e) {
        $('#length').val('');
        filamentComputeCostOnChange();
    });
    $('input[name=weighUnit]').change(function(e) {
        $('#length').val('');
        filamentComputeCostOnChange();
    });

    $('#filament-list').height('calc(100vh - ' + ($('#filament-list').offset().top + 30) + 'px)')

    $('.filament-item').click(function(e) {
        e.preventDefault();

        var $this = $(this);

        $('.filament-item.selected').removeClass('selected');
        $this.addClass('selected');

        var $filamentDetails = $('.filament-details');
        var filament = $this.data('filament');

        if (!filament) {
            return;
        }

        $filamentDetails.data('id', filament._id);

        $filamentDetails.find('.color-preview').attr('title', filament.color.name).css('background-color', filament.color.code)
                .find('.color-name').text(filament.color.name);
        $filamentDetails.find('.filament-material-name').text(filament.material.name);
        $filamentDetails.find('.filament-weight').text(Locale3DPTools.__('%s kg', filament.initialMaterialWeight));
        $filamentDetails.find('.filament-diameter').text(filament.diameter);
        $filamentDetails.find('.filament-density').text(Locale3DPTools.__('%s kg/m³', filament.density));

        if (filament.brand.logo && filament.brand.logo.size) {
            $filamentDetails.find('.filament-brand-logo').html('<img alt="'+filament.brand.name+'" title="'+filament.brand.name+'" class="brand-logo" src="/brand/get-logo/'+filament.brand.id+'">');
        } else {
            $filamentDetails.find('.filament-brand-logo').text(filament.brand.name);
        }

        var progress = $filamentDetails.find('.progress');
        if (progress) {
            var progressbarClass = 'progress-bar-success';
            if (filament.materialLeftPercentage <= <%- config.get('filament:leftThresholds:warning') %>) {
                progressbarClass = 'progress-bar-warning'
            }
            if (filament.materialLeftPercentage <= <%- config.get('filament:leftThresholds:danger') %>) {
                progressbarClass = 'progress-bar-danger'
            }

            progress.find('.progress-bar')
                    .width(filament.materialLeftPercentage+'%')
                    .removeClass('progress-bar-success')
                    .removeClass('progress-bar-warning')
                    .removeClass('progress-bar-danger')
                    .addClass(progressbarClass);
            if (filament.materialLeftPercentage > 50) {
                progress.find('.progress-bar').text(sprintf('%.2f%%', filament.materialLeftPercentage));
                progress.find('.progress-text').text('');
            } else {
                progress.find('.progress-bar').text('');
                progress.find('.progress-text').text(sprintf('%.2f%%', filament.materialLeftPercentage)).css({ paddingLeft: filament.materialLeftPercentage+'%'});
            }
            progress.show();
        } else if (progress) {
            progress.hide();
        }
        $filamentDetails.find('.filament-left-data').text(Locale3DPTools.__('~ %.2f Kg / ~ %.2f m', $this.data('left-weight'), $this.data('left-length')));

        if (filament.shop.url) {
            $filamentDetails.find('.filament-shop-logo').html('<img alt="'+filament.shop.name+'" title="'+filament.shop.name+'" class="brand-logo" src="/shop/get-logo/'+filament.shop.id+'">');
        } else {
            $filamentDetails.find('.filament-shop-logo').text(filament.shop.name);
        }

        $filamentDetails.find('.filament-buy-date').text(moment(filament.buyDate).format('LL'));
        $filamentDetails.find('.filament-price').text(Locale3DPTools.__('%.2f € TTC', filament.price));

        $('#compute-form').show();

        var $lengthInput = $('#length');
        var $weightInput = $('#weight');
        if (($weightInput.val() != '') && ($lengthInput.val() == '')) {
            $weightInput.focus();
        } else {
            $lengthInput.focus();
        }


        window.location.hash = filament._id;

        $('form.form-filament').trigger('submit');
    })

    if (window.location.hash) {
        var $item = $('.filament-item#filament-'+window.location.hash.replace(/^#/, ''));
        $item.trigger('click');
        $('#filament-list').scrollTop($item.position().top - $item.height());
    }

});
</script>