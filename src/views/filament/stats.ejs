<a name="page-top" id="page-top" class="anchor"></a>
<% var chartsColors = config.get('charts:colors'); %>
<script src="/vendor/highcharts/highcharts.js"></script>
<script src="/javascripts/highcharts-locales/<%- getLocale() %>.js"></script>

<script type="text/javascript">
    // Microsoft Pastel chart series colors
    //var chartsColors = ['#87CEEB', '#32CD32', '#BA55D3', '#F08080', '#4682B4', '#9ACD32', '#40E0D0', '#FF69B4', '#F0E68C', '#D2B48C', '#8FBC8B', '#6495ED', '#DDA0DD', '#5F9EA0', '#FFDAB9', '#FFA07A'];
    // D3 category10
    //var colors = ['#0072AD', '#FF7C15', '#009D37', '#DC141D', '#955EB7', '#8C5049', '#E96FBE', '#7D7D7D', '#B7BD36', '#00BCCB'];
    // D3 category20
    var chartsColors = <%- sprintf('%-j', chartsColors) %>;
    $(function () {
        Highcharts.setOptions({
            credits: {
                enabled: false
            },
            chart: {
                backgroundColor: 'transparent',
                animation: false
            },
            plotOptions: {
                series: {
                    animation: false
                },
                pie: {
                    dataLabels: {
                        y: -10
                    }
                }
            },
            title: {
                useHTML: true
            },
            colors: chartsColors
        });
    });
</script>

<ul class="nav nav-tabs nav-tabs-title">
    <li role="presentation" class="active"><h1><i class="fa fa-pie-chart"></i> <%- __('Filaments statistics') %></h1></li>
    <li role="presentation"><a href="/filament"><i class="rs rs-filament"></i>&nbsp;<%- __('Filaments') %></a></li>
</ul>

<% if (stats.totals.count) { %>

<div id="stats-container">

    <div id="stats-menu">
        <nav class="nav-sidemenu hidden-print hidden-sm hidden-xs affix" data-offset-top="78" data-spy="affix">
            <ul class="nav">
                <li class="active"><a href="#page-top"><%- __('Page top'); %></a></li>
            </ul>
            <br/>
            <ul class="nav">
                <li><a href="#totals"><%- __('Totals'); %></a></li>
                <li><a href="#global-usage"><%- __('Usage'); %></a></li>
                <li><a href="#price-per-kg"><%- __('Price per Kg'); %></a></li>
                <li><a href="#buy-history"><%- __('Bought history'); %></a></li>
                <li>
                    <a href="#usages"><%- __('Most used'); %></a>
                    <ul class="nav">
                        <li><a href="#usage-per-color"><%- __('By colors'); %></a></li>
                        <li><a href="#usage-per-material"><%- __('By materials'); %></a></li>
                        <li><a href="#usage-per-brand"><%- __('By brands'); %></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#counts"><%- __('Counts'); %></a>
                    <ul class="nav">
                        <li><a href="#count-per-brand"><%- __('By brands'); %></a></li>
                        <li><a href="#count-per-shop"><%- __('By shops'); %></a></li>
                        <li><a href="#count-per-material"><%- __('By materials'); %></a></li>
                        <li><a href="#count-per-color"><%- __('By colors'); %></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#costs"><%- __('Costs'); %></a>
                    <ul class="nav">
                        <li><a href="#cost-per-brand"><%- __('By brands'); %></a></li>
                        <li><a href="#cost-per-shop"><%- __('By shops'); %></a></li>
                        <li><a href="#cost-per-material"><%- __('By materials'); %></a></li>
                        <li><a href="#cost-per-color"><%- __('By colors'); %></a></li>
                    </ul>
                </li>
            </ul>
        </nav>

    </div>

    <div id="stats-graphs">

    <% if (stats && stats.totals) { %>
    <a name="totals" id="totals" class="anchor"></a>
    <div class="panel panel-default filament-stats">
        <div class="panel-heading">
            <h2 class="panel-title"><%- __('Totals'); %></h2>
        </div>
        <div class="panel-body row">
            <% if (stats.totals.count) { %>
            <div class="col-md-3 filament-stats-text"><i class="rs rs-filament"></i> <%- __('%d filaments', stats.totals.count) %></div>
            <% } %>
            <% if (stats.totals.cost) { %>
            <div class="col-md-3 filament-stats-text"><i class="fa fa-money"></i> <%- __('%.2f €', stats.totals.cost) %></div>
            <% } %>
            <% if (stats.totals.weight) { %>
            <div class="col-md-3 filament-stats-text"><i class="p3di p3di-weight"></i> <%- __('%.2f Kg', stats.totals.weight) %></div>
            <% } %>
            <% if (stats.totals.length) { %>
                <% if (stats.totals.length > 1000) { %>
                    <div class="col-md-3 filament-stats-text"><i class="p3di p3di-ruler"></i>  <%- __('%.2f km', stats.totals.length / 1000) %></div>
                <% } else { %>
                    <div class="col-md-3 filament-stats-text"><%- __('%.2f m', stats.totals.length) %></div>
                <% } %>
            <% } %>
        </div>
    </div>
    <% } %>

    <% if (stats && stats.usage) { %>
    <a name="global-usage" id="global-usage" class="anchor"></a>
    <div class="panel panel-default filament-stats">
        <div class="panel-heading">
            <h2 class="panel-title"><%- __('Usage'); %></h2>
        </div>
        <div class="panel-body row">
            <% if (stats.usage.weight) { %>
            <div class="col-md-4 filament-stats-graph">
                <div class="filament-stats-text">
                    <i class="p3di p3di-weight"></i> <%- __('Weight') %>
                </div>
                <div id="filament-stats-usage-by-weight"></div>
                <script type="text/javascript">
                    $(function () {
                        $('#filament-stats-usage-by-weight').highcharts({
                            chart: {
                                type: 'pie',
                                height: 180,
                                spacingTop: 0,
                                marginTop: 0,
                                spacingLeft: 0,
                                marginLeft: 0,
                                spacingRight: 0,
                                marginRight: 0,
                                spacingBottom: 0,
                                marginBottom: -200
                            },
                            title: null,
                            tooltip: {
                                pointFormat: '<b>{point.percentage:.1f}%</b>'
                            },
                            plotOptions: {
                                pie: {
                                    allowPointSelect: false,
                                    dataLabels: {
                                        enabled: true,
                                        distance: -50,
                                        format: '{point.y:.2f} Kg'
                                    },
                                    startAngle: -90,
                                    endAngle: 90,
                                    center: ['50%', '50%']
                                }
                            },
                            series: [{
                                name: '<%- __('Weight'); %>',
                                innerSize: '50%',
                                data: [
                                    {
                                        name: '<%- __('Left:'); %>',
                                        y: <%- stats.usage.weight.left %>,
                                        color: chartsColors[0]
                                    },
                                    {
                                        name: '<%- __('Used:'); %>',
                                        y: <%- stats.usage.weight.used %>,
                                        color: chartsColors[1]
                                    }
                                ]
                            }]
                        });
                    });
                </script>
            </div>
            <% } %>
            <% if (stats.usage.length) { %>
            <div class="col-md-4 filament-stats-graph">
                <div class="filament-stats-text">
                    <i class="p3di p3di-ruler"></i> <%- __('Length') %>
                </div>
                <div id="filament-stats-usage-by-length"></div>
                <script type="text/javascript">
                    $(function () {
                        $('#filament-stats-usage-by-length').highcharts({
                            chart: {
                                type: 'pie',
                                height: 180,
                                spacingTop: 0,
                                marginTop: 0,
                                spacingLeft: 0,
                                marginLeft: 0,
                                spacingRight: 0,
                                marginRight: 0,
                                spacingBottom: 0,
                                marginBottom: -200
                            },
                            title: null,
                            tooltip: {
                                pointFormat: '<b>{point.percentage:.1f}%</b>'
                            },
                            plotOptions: {
                                pie: {
                                    allowPointSelect: false,
                                    dataLabels: {
                                        enabled: true,
                                        distance: -50,
                                        format: '{point.valueLabel}'
                                    },
                                    startAngle: -90,
                                    endAngle: 90,
                                    center: ['50%', '50%']
                                }
                            },
                            series: [{
                                name: '<%- __('Length'); %>',
                                innerSize: '50%',
                                data: [
                                    {
                                        name: '<%- __('Left:'); %>',
                                        y: <%- stats.usage.length.left %>,
                                        <% if (stats.usage.length.left>1000) { %>
                                        valueLabel: '<%- __('%.2f km', stats.usage.length.left/1000) %>',
                                        <% } else { %>
                                        valueLabel: '<%- __('%.2f m', stats.usage.length.left) %>',
                                        <% } %>
                                        color: chartsColors[2]
                                    },
                                    {
                                        name: '<%- __('Used:'); %>',
                                        y: <%- stats.usage.length.used %>,
                                        <% if (stats.usage.length.used>1000) { %>
                                        valueLabel: '<%- __('%.2f km', stats.usage.length.used/1000) %>',
                                        <% } else { %>
                                        valueLabel: '<%- __('%.2f m', stats.usage.length.used) %>',
                                        <% } %>
                                        color: chartsColors[3]
                                    }
                                ]
                            }]
                        });
                    });
                </script>
            </div>
            <% } %>
            <% if (stats.usage.cost) { %>
            <div class="col-md-4 filament-stats-graph">
                <div class="filament-stats-text">
                    <i class="fa fa-money"></i> <%- __('Cost') %>
                </div>
                <div id="filament-stats-usage-by-cost"></div>
                <script type="text/javascript">
                    $(function () {
                        $('#filament-stats-usage-by-cost').highcharts({
                            chart: {
                                type: 'pie',
                                height: 180,
                                spacingTop: 0,
                                marginTop: 0,
                                spacingLeft: 0,
                                marginLeft: 0,
                                spacingRight: 0,
                                marginRight: 0,
                                spacingBottom: 0,
                                marginBottom: -200
                            },
                            title: null,
                            tooltip: {
                                pointFormat: '<b>{point.percentage:.1f}%</b>'
                            },
                            plotOptions: {
                                pie: {
                                    allowPointSelect: false,
                                    dataLabels: {
                                        enabled: true,
                                        distance: -50,
                                        format: '{point.y:.2f} €'
                                    },
                                    startAngle: -90,
                                    endAngle: 90,
                                    center: ['50%', '50%']
                                }
                            },
                            series: [{
                                name: '<%- __('Cost'); %>',
                                innerSize: '50%',
                                data: [
                                    {
                                        name: '<%- __('Left:'); %>',
                                        y: <%- stats.usage.cost.left %>,
                                        color: chartsColors[4]
                                    },
                                    {
                                        name: '<%- __('Used:'); %>',
                                        y: <%- stats.usage.cost.used %>,
                                        color: chartsColors[5]
                                    }
                                ]
                            }]
                        });
                    });
                </script>
            </div>
            <% } %>
        </div>
    </div>
    <% } %>

    <% if (stats && stats.pricePerKg) { %>
    <a name="price-per-kg" id="price-per-kg" class="anchor"></a>
    <div class="panel panel-default filament-stats">
        <div class="panel-heading">
            <h2 class="panel-title"><%- __('Price per Kg'); %></h2>
        </div>
        <div class="panel-body ">
            <div id="filament-stats-price-per-kg"></div>
            <script type="text/javascript">
                $(function () {
                    $('#filament-stats-price-per-kg').highcharts({
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: '<i class="fa fa-leaf"></i> <%- __('By materials'); %>'
                        },
                        xAxis: {
                            categories:  <%- sprintf('%-j', stats.pricePerKg.map(function(doc) {
                                return doc.material.name;
                            })); %>
                        },
                        yAxis: [{
                            min: 0,
                            title: {
                                enabled: true,
                                text: '<%- __('€/Kg') %>',
                                style: {
                                    color: 'gray'
                                }
                            },
                            labels:{
                                style: {
                                    color: 'gray'
                                }
                            },
                        },
                        {
                            min: 0,
                            title: {
                                enabled: false,
                                text: '<%- __('Kg') %>',
                                style: {
                                    color: 'lightgray'
                                }
                            },
                            labels:{
                                format: '{value} Kg',
                                style: {
                                    color: 'lightgray'
                                }
                            },
                            opposite: true
                        }],
                        legend: {
                            enabled: false
                        },
                        plotOptions: {
                            series: {
                                borderWidth: 0,
                                dataLabels: {
                                    enabled: true,
                                    format: '{point.y:.2f}',
                                    style: {
                                        color: 'gray'
                                    }
                                }
                            },
                            column: {
                                tooltip: {
                                    useHTML: true,
                                    pointFormat: '<span style="color:{point.borderColor}">\u25CF</span><b>{point.pricePerKg:.2f} €/Kg</b>' +
                                    '<br/><span style="color:{point.borderColor}">\u25CF</span><b><%- __('Count: ') %></b> {point.count}' +
                                    '<br/><span style="color:{point.borderColor}">\u25CF</span><b><%- __('Total: ') %></b> {point.materialWeight:.2f} Kg' +
                                    '<br/><span style="color:{point.borderColor}">\u25CF</span><b><%- __('Total: ') %></b> {point.totalCost:.2f} €'
                                }
                            }
                        },
                        series: [{
                            name: 'perKg',
                            yAxis: 0,
                            dataLabels: {
                                enabled: true,
                                format: '{point.y:.2f}',
                                style: {
                                    color: 'gray',
                                    textShadow: 0
                                }
                            },
                            data: <% var colorIdx = 0; %><%- sprintf('%-j', stats.pricePerKg.map(function(doc) {
                            doc.y = doc.pricePerKg;
                            doc.color = chartsColors[colorIdx];
                            doc.borderColor = chartsColors[colorIdx];
                            colorIdx += 2;
                            if (colorIdx > chartsColors.length) {
                                colorIdx = 0;
                            }
                            return doc;
                        })); %>
                        },
                        {
                            name: 'totalWeight',
                            yAxis: 1,
                            dataLabels: {
                                enabled: true,
                                format: '{point.y:.2f}',
                                style: {
                                    color: 'lightgray',
                                    textShadow: 0
                                }
                            },
                            data: <% var colorIdx = 1; %><%- sprintf('%-j', stats.pricePerKg.map(function(doc) {
                            doc.y = doc.materialWeight;
                            doc.color = chartsColors[colorIdx];
                            doc.borderColor = chartsColors[colorIdx];
                            colorIdx += 2;
                            if (colorIdx > chartsColors.length) {
                                colorIdx = 0;
                            }
                            return doc;
                        })); %>
                        }]
                    });
                });
            </script>
        </div>
    </div>
    <% } %>


    <% if (stats && (stats.boughtHistory || stats.purchaseInterval)) { %>
    <a name="buy-history" id="buy-history" class="anchor"></a>
    <div class="panel panel-default filament-stats">
        <div class="panel-heading">
            <h2 class="panel-title"><%- __('Bought history'); %></h2>
        </div>
        <% if (stats.boughtHistory) { %>
        <div class="panel-body ">
            <div id="filament-stats-bought-history"></div>
            <script type="text/javascript">
                $(function () {
                    $('#filament-stats-bought-history').highcharts({
                        chart: {
                            zoomType: 'x'
                        },
                        title: {
                            text: ''
                        },
                        subtitle: {
                            verticalAlign: 'bottom',
                            y: 5,
                            text: document.ontouchstart === undefined ?
                                    '<%- __('Click and drag in the plot area to zoom in') %>' : '<%- __('Pinch the chart to zoom in') %>'
                        },
                        xAxis: {
                            type: 'datetime'
                        },
                        yAxis: [
                            {
                                title: {
                                    enabled: false,
                                    text: '<%- __('Count') %>',
                                    style: {
                                        color: chartsColors[0]
                                    }
                                },
                                labels: {
                                    format: '{value}',
                                    style: {
                                        color: chartsColors[0]
                                    }
                                }
                            },
                            {
                                title: {
                                    enabled: false,
                                    text: '<%- __('Cost') %>',
                                    style: {
                                        color: chartsColors[2]
                                    }
                                },
                                labels: {
                                    format: '{value} €',
                                    style: {
                                        color: chartsColors[2]
                                    }
                                },
                                opposite: true
                            }
                        ],
                        tooltip: {
                            crosshairs: true
                        },
                        legend: {
                            enabled: true
                        },
                        plotOptions: {
                            spline: {
                                marker: {
                                    enabled: true,
                                    radius: 3
                                },
                                lineWidth: 1
                            }
                        },
                        series: [{
                            type: 'spline',
                            name: '<%- __('Count') %>',
                            yAxis: 0,
                            color: chartsColors[0],
                            tooltip: {
                                pointFormat: '<b>{series.name}:</b> {point.y}<br/><b><%- __('Names: ') %></b>{point.namesString}<br/><b><%- __('Shops: ') %></b>{point.shopsString}<br/><b><%- __('Brands: ') %></b>{point.brandsString}'
                            },
                            data: <%- sprintf('%-j', stats.boughtHistory.map(function(doc) {
                                doc.x = doc.buyTimestamp;
                                doc.y = doc.count;
                                doc.name = doc.label;
                                doc.namesString = doc.names.join(', ');
                                doc.shopsString = doc.shops.join(', ');
                                doc.brandsString = doc.brands.join(', ');
                                return doc;
                            })); %>
                        },{
                            type: 'spline',
                            name: '<%- __('Cost') %>',
                            yAxis: 1,
                            color: chartsColors[2],
                            tooltip: {
                                pointFormat: '<b>{series.name}:</b> {point.y:.2f} €<br/><b><%- __('Names: ') %></b>{point.namesString}<br/><b><%- __('Shops: ') %></b>{point.shopsString}<br/><b><%- __('Brands: ') %></b>{point.brandsString}'
                            },
                            data: <%- sprintf('%-j', stats.boughtHistory.map(function(doc) {
                                doc.x = doc.buyTimestamp;
                                doc.y = doc.cost;
                                doc.namesString = doc.names.join(', ');
                                doc.shopsString = doc.shops.join(', ');
                                doc.brandsString = doc.brands.join(', ');
                                return doc;
                            })); %>
                        },{
                            type: 'spline',
                            name: '<%- __('Cost/filament') %>',
                            yAxis: 1,
                            color: chartsColors[4],
                            tooltip: {
                                pointFormat: '<b>{series.name}:</b> {point.y:.2f} €<br/><b><%- __('Names: ') %></b>{point.namesString}<br/><b><%- __('Shops: ') %></b>{point.shopsString}<br/><b><%- __('Brands: ') %></b>{point.brandsString}'
                            },
                            visible: false,
                            data: <%- sprintf('%-j', stats.boughtHistory.map(function(doc) {
                                if (doc.count > 0) {
                                    doc.x = doc.buyTimestamp;
                                    doc.y = doc.cost / doc.count;
                                    doc.namesString = doc.names.join(', ');
                                    doc.shopsString = doc.shops.join(', ');
                                    doc.brandsString = doc.brands.join(', ');
                                    return doc;
                                }
                            })); %>
                        },{
                            type: 'spline',
                            name: '<%- __('Cost/Kg') %>',
                            yAxis: 1,
                            color: chartsColors[6],
                            tooltip: {
                                pointFormat: '<b>{series.name}:</b> {point.y:.2f} €<br/><b><%- __('Names: ') %></b>{point.namesString}<br/><b><%- __('Shops: ') %></b>{point.shopsString}<br/><b><%- __('Brands: ') %></b>{point.brandsString}'
                            },
                            visible: false,
                            data: <%- sprintf('%-j', stats.boughtHistory.map(function(doc) {
                                if (doc.materialWeight > 0) {
                                    doc.x = doc.buyTimestamp;
                                    doc.y = doc.cost / doc.materialWeight;
                                    doc.namesString = doc.names.join(', ');
                                    doc.shopsString = doc.shops.join(', ');
                                    doc.brandsString = doc.brands.join(', ');
                                    return doc;
                                }
                            })); %>
                        }]
                    });
                });
            </script>
        </div>
        <% } %>
        <% if (stats.purchaseInterval) { %>
        <div class="panel-body row">
            <% if (stats.purchaseInterval.averageInterval) { %>
            <div class="col-md-6 filament-stats-text"><i class="fa fa-clock-o"></i> <%- __('Average purchase interval: %s', moment(0).from(moment(stats.purchaseInterval.averageInterval), true)) %></div>
            <% } %>
            <% if (stats.purchaseInterval.lastPurchase) { %>
            <div class="col-md-6 filament-stats-text"><i class="fa fa-calendar"></i> <%- __('Last purchase %s', moment(0).from(moment(stats.purchaseInterval.lastPurchase))); %></div>
            <% } %>
        </div>
        <% } %>
    </div>
    <% } %>

    <% if (stats && stats.usagePer) { %>
    <a name="usages" id="usages" class="anchor"></a>
    <div class="panel panel-default filament-stats">
        <div class="panel-heading">
            <h2 class="panel-title"><%- __('Most used'); %></h2>
        </div>
        <div class="panel-body filament-stats-graph">
            <% if (stats && stats.usagePer.colors) { %>
            <a name="usage-per-color" id="usage-per-color" class="anchor"></a>
            <div id="filament-stats-most-used-by-colors"></div>
            <script type="text/javascript">
                $(function () {
                    $('#filament-stats-most-used-by-colors').highcharts({
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: '<i class="fa fa-tint"></i> <%- __('By colors'); %>'
                        },
                        xAxis: {
                            categories:  <%- sprintf('%-j', stats.usagePer.colors.map(function(doc) {
                                return doc._id.name;
                            })); %>
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                enabled: true,
                                text: '<%- __('Kg') %>'
                            },
                            stackLabels: {
                                enabled: false,
                                style: {
                                    fontWeight: 'bold',
                                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                                }
                            }
                        },
                        legend: {
                            enabled: false
                        },
                        plotOptions: {
                            column: {
                                stacking: 'normal',
                                dataLabels: {
                                    enabled: false,
                                    color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                                    style: {
                                        textShadow: '0 0 3px black'
                                    }
                                },
                                tooltip: {
                                    useHTML: true,
                                    pointFormat: '<span style="color:{point.borderColor}">\u25CF</span><b><%- __('Used: ') %></b> {point.totalUsedWeight:.2f} Kg<br/><span style="color:{point.borderColor}">\u25CF</span><b><%- __('Left: ') %></b> {point.totalLeftWeight:.2f} Kg',
                                    borderColor: "red"
                                }
                            }
                        },
                        series: [{
                            name: '<%- __('Used') %>',
                            color: 'transparent',
                            states: {
                                hover: {
                                    enabled: false
                                }
                            },
                            data: <% var whiteColor = new Color('#FFFFFF'); %><%- sprintf('%-j', stats.usagePer.colors.map(function(doc) {
                            doc.y = doc.totalUsedWeight;
                            var color = new Color(doc._id.code);
                            if (color.hex() == whiteColor.hex()) {
                                doc.borderColor = '#DDDDDD';
                            } else {
                                doc.borderColor = doc._id.code;
                            }
                            return doc;
                        })); %>
                        },{
                            name: '<%- __('Left') %>',
                            states: {
                                hover: {
                                    enabled: false
                                }
                            },
                            data: <%- sprintf('%-j', stats.usagePer.colors.map(function(doc) {
                                doc.y = doc.totalLeftWeight;
                                doc.color = doc._id.code;
                                return doc;
                            })); %>
                        }]
                    });
                });
            </script>
            <% } %>

            <% if (stats.usagePer.materials || stats.usagePer.brands) { %>
            <div class="row">
                <% if (stats.usagePer.materials) { %>
                <a name="usage-per-material" id="usage-per-material" class="anchor"></a>
                <div class="col-md-6 filament-stats-graph">
                    <div id="filament-stats-most-used-by-materials"></div>
                    <script type="text/javascript">
                        $(function () {
                            $('#filament-stats-most-used-by-materials').highcharts({
                                chart: {
                                    type: 'column'
                                },
                                title: {
                                    text: '<i class="fa fa-leaf"></i> <%- __('By materials'); %>'
                                },
                                xAxis: {
                                    categories:  <%- sprintf('%-j', stats.usagePer.materials.map(function(doc) {
                                        return doc.label;
                                    })); %>
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        enabled: true,
                                        text: '<%- __('Kg') %>'
                                    },
                                    stackLabels: {
                                        enabled: false,
                                        style: {
                                            fontWeight: 'bold',
                                            color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                                        }
                                    }
                                },
                                legend: {
                                    enabled: false
                                },
                                plotOptions: {
                                    column: {
                                        stacking: 'normal',
                                        dataLabels: {
                                            enabled: false,
                                            color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                                            style: {
                                                textShadow: '0 0 3px black'
                                            }
                                        },
                                        tooltip: {
                                            useHTML: true,
                                            pointFormat: '<span style="color:{point.borderColor}">\u25CF</span><b><%- __('Used: ') %></b> {point.totalUsedWeight:.2f} Kg<br/><span style="color:{point.borderColor}">\u25CF</span><b><%- __('Left: ') %></b> {point.totalLeftWeight:.2f} Kg',
                                            borderColor: "red"
                                        }
                                    }
                                },
                                series: [{
                                    name: '<%- __('Used') %>',
                                    color: 'transparent',
                                    states: {
                                        hover: {
                                            enabled: false
                                        }
                                    },
                                    data: <% var colorIdx = 0; %><%- sprintf('%-j', stats.usagePer.materials.map(function(doc) {
                                        doc.y = doc.totalUsedWeight;
                                        doc.borderColor = chartsColors[colorIdx];
                                        colorIdx += 2;
                                        if (colorIdx > chartsColors.length) {
                                            colorIdx = 0;
                                        }
                                        return doc;
                                    })); %>
                                },{
                                    name: '<%- __('Left') %>',
                                    states: {
                                        hover: {
                                            enabled: false
                                        }
                                    },
                                    data: <% var colorIdx = 0; %><%- sprintf('%-j', stats.usagePer.materials.map(function(doc) {
                                        doc.y = doc.totalLeftWeight;
                                        doc.color = chartsColors[colorIdx];
                                        colorIdx += 2;
                                        if (colorIdx > chartsColors.length) {
                                            colorIdx = 0;
                                        }
                                        return doc;
                                    })); %>
                                }]
                            });
                        });
                    </script>
                </div>
                <% } %>

                <% if (stats.usagePer.brands) { %>
                <a name="usage-per-brand" id="usage-per-brand" class="anchor"></a>
                <div class="col-md-6 filament-stats-graph">
                    <div id="filament-stats-most-used-by-brands"></div>
                    <script type="text/javascript">
                        $(function () {
                            $('#filament-stats-most-used-by-brands').highcharts({
                                chart: {
                                    type: 'column'
                                },
                                title: {
                                    text: '<i class="fa fa-trademark"></i> <%- __('By brands'); %>'
                                },
                                xAxis: {
                                    categories:  <%- sprintf('%-j', stats.usagePer.brands.map(function(doc) {
                                        return doc.label;
                                    })); %>
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        enabled: true,
                                        text: '<%- __('Kg') %>'
                                    },
                                    stackLabels: {
                                        enabled: false,
                                        style: {
                                            fontWeight: 'bold',
                                            color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                                        }
                                    }
                                },
                                legend: {
                                    enabled: false
                                },
                                plotOptions: {
                                    column: {
                                        stacking: 'normal',
                                        dataLabels: {
                                            enabled: false,
                                            color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                                            style: {
                                                textShadow: '0 0 3px black'
                                            }
                                        },
                                        tooltip: {
                                            useHTML: true,
                                            pointFormat: '<span style="color:{point.borderColor}">\u25CF</span><b><%- __('Used: ') %></b> {point.totalUsedWeight:.2f} Kg<br/><span style="color:{point.borderColor}">\u25CF</span><b><%- __('Left: ') %></b> {point.totalLeftWeight:.2f} Kg',
                                            borderColor: "red"
                                        }
                                    }
                                },
                                series: [{
                                    name: '<%- __('Used') %>',
                                    color: 'transparent',
                                    states: {
                                        hover: {
                                            enabled: false
                                        }
                                    },
                                    data: <% var colorIdx = 0; %><%- sprintf('%-j', stats.usagePer.brands.map(function(doc) {
                                    doc.y = doc.totalUsedWeight;
                                    doc.borderColor = chartsColors[colorIdx];
                                    colorIdx += 2;
                                    if (colorIdx > chartsColors.length) {
                                        colorIdx = 0;
                                    }
                                    return doc;
                                })); %>
                                },{
                                    name: '<%- __('Left') %>',
                                    states: {
                                        hover: {
                                            enabled: false
                                        }
                                    },
                                    data: <% var colorIdx = 0; %><%- sprintf('%-j', stats.usagePer.brands.map(function(doc) {
                                    doc.y = doc.totalLeftWeight;
                                    doc.color = chartsColors[colorIdx];
                                    colorIdx += 2;
                                    if (colorIdx > chartsColors.length) {
                                        colorIdx = 0;
                                    }
                                    return doc;
                                })); %>
                                }]
                            });
                        });
                    </script>
                </div>
                <% } %>
            </div>
            <% } %>
        </div>
    </div>
    <% } %>

    <div class="row">
    <% if (stats && stats.count) { %>
        <a name="counts" id="counts" class="anchor"></a>
        <div class="col-md-6">
            <div class="panel panel-default filament-stats filament-stats-vertical-stack">
                <div class="panel-heading">
                    <h2 class="panel-title"><%- __('Counts'); %></h2>
                </div>
                <div class="panel-body">
                    <% if (stats.count.byBrands) { %>
                    <a name="count-per-brand" id="count-per-brand" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-count-by-brands"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-count-by-brands').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-trademark"></i> <%- __('By brands'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y}</b>'
                                    },
                                    plotOptions: {
                                        pie: {
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.count.byBrands.map(function(doc) {
                                            doc.y = doc.count;
                                            doc.name = doc.label;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>

                    <% if (stats.count.byShops) { %>
                    <a name="count-per-shop" id="count-per-shop" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-count-by-shops"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-count-by-shops').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-shopping-bag"></i> <%- __('By shops'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y}</b>'
                                    },
                                    plotOptions: {
                                        pie: {
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.count.byShops.map(function(doc) {
                                            doc.y = doc.count;
                                            doc.name = doc.label;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>

                    <% if (stats.count.byMaterials) { %>
                    <a name="count-per-material" id="count-per-material" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-count-by-materials"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-count-by-materials').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-leaf"></i> <%- __('By materials'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y}</b>'
                                    },
                                    plotOptions: {
                                        pie: {
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.count.byMaterials.map(function(doc) {
                                            doc.y = doc.count;
                                            doc.name = doc.label;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>

                    <% if (stats.count.byColors) { %>
                    <a name="count-per-color" id="count-per-color" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-count-by-colors"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-count-by-colors').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-tint"></i> <%- __('By colors'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '{point.percentage:.1f}%<br/><b>{point.y}</b>'
                                    },
                                    plotOptions: {
                                        pie: {
                                            borderColor: '#dddddd',
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b><br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.count.byColors.map(function(doc) {
                                            doc.y = doc.count;
                                            doc.name = doc.label;
                                            doc.color = doc._id.code;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
        <% } %>

        <% if (stats && stats.costs) { %>
        <a name="costs" id="costs" class="anchor"></a>
        <div class="col-md-6">
            <div class="panel panel-default filament-stats filament-stats-vertical-stack">
                <div class="panel-heading">
                    <h2 class="panel-title"><%- __('Costs'); %></h2>
                </div>
                <div class="panel-body">
                    <% if (stats.costs.byBrands) { %>
                    <a name="cost-per-brand" id="cost-per-brand" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-cost-by-brands"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-cost-by-brands').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-trademark"></i> <%- __('By brands'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y:.2f}</b> €'
                                    },
                                    plotOptions: {
                                        pie: {
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.costs.byBrands.map(function(doc) {
                                            doc.y = doc.cost;
                                            doc.name = doc.label;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>

                    <% if (stats.costs.byShops) { %>
                    <a name="cost-per-shop" id="cost-per-shop" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-cost-by-shops"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-cost-by-shops').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-shopping-bag"></i> <%- __('By shops'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y:.2f}</b> €'
                                    },
                                    plotOptions: {
                                        pie: {
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.costs.byShops.map(function(doc) {
                                            doc.y = doc.cost;
                                            doc.name = doc.label;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>

                    <% if (stats.costs.byMaterials) { %>
                    <a name="cost-per-material" id="cost-per-material" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-cost-by-materials"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-cost-by-materials').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-leaf"></i> <%- __('By materials'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y:.2f}</b> €'
                                    },
                                    plotOptions: {
                                        pie: {
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.costs.byMaterials.map(function(doc) {
                                            doc.y = doc.cost;
                                            doc.name = doc.label;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>

                    <% if (stats.costs.byColors) { %>
                    <a name="cost-per-color" id="cost-per-color" class="anchor"></a>
                    <div class="filament-stats-graph">
                        <div id="filament-stats-cost-by-colors"></div>
                        <script type="text/javascript">
                            $(function () {
                                $('#filament-stats-cost-by-colors').highcharts({
                                    chart: {
                                        type: 'pie'
                                    },
                                    title: {
                                        text: '<i class="fa fa-tint"></i> <%- __('By colors'); %>'
                                    },
                                    tooltip: {
                                        pointFormat: '<b>{point.y:.2f}</b> €'
                                    },
                                    plotOptions: {
                                        pie: {
                                            borderColor: '#dddddd',
                                            allowPointSelect: true,
                                            cursor: 'pointer',
                                            dataLabels: {
                                                enabled: true,
                                                format: '<b>{point.name}</b>:<br/>{point.percentage:.1f}%'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: '<%- __('Cost'); %>',
                                        data: <%- sprintf('%-j', stats.costs.byColors.map(function(doc) {
                                            doc.y = doc.cost;
                                            doc.name = doc.label;
                                            doc.color = doc._id.code;
                                            return doc;
                                        })); %>
                                    }]
                                });
                            });
                        </script>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
        <% } %>
    </div>

    </div> <!-- end graphs -->

</div>
<% } else { /* if (stats.totals.count) */ %>
<center>
    <%- __('No filament found.') %><br><br>
    <a href="/filament/add" class="btn btn-primary"><i class="fa fa-plus"></i>&nbsp;<%- __('Add filament') %></a>
</center>
<% } %>

<script type="text/javascript">
    $(function() {
        $('body').scrollspy({ target: '#stats-menu' });
    });
</script>