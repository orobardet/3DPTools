<script src="/vendor/javascripts/vue<%- (environment === 'production') ? '.min' : '' %>.js"></script>
<script src="/vendor/javascripts/moment.min.js"></script>
<script src="/vendor/javascripts/moment-duration-format.js"></script>
<script src="/vendor/locales/fr.js"></script>

<div id="system-information">
    <div>
    <div class="pull-right" v-if="initialized">
        <span class="last-update" v-show="lastUpdateDate">{{ lastUpdateDate.format('Do MMMM YYYY LTS') }}</span>
        <div class="btn-group">
            <button type="button" class="btn btn-default" @click="toggleAutoRefresh()" :class="{ active: autoRefresher.timer, 'btn-success': autoRefresher.timer }">
                <i class="fa fa-refresh"></i> <%- __("Auto refresh (%s)", "{{autoRefresher.currentDelay.label}}"); %>
            </button>
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" :class="{ 'btn-success': autoRefresher.timer }">
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right">
                <li v-for="delay of autoRefresher.delayChoices" @click="setAutoRefreshDelay(delay)"><a data-target="#" data-value="delay.ms" key="delay.label">{{delay.label}}</a></li>
            </ul>
        </div>
    </div>
    <h1><%= __(pageTitle) %></h1>
    </div>
<div id="app-loader" style="text-align: center; font-weight: bold; font-size: larger;margin-top: 50px;" v-if="!initialized">Loading data...</div>

<div class="row" style="display:none;" v-show="initialized">
    <div class="col-md-6" v-if="system.app">
        <div class="panel panel-default">
            <div class="panel-heading"><b><%= siteTitle %> application</b></div>
            <div class="panel-body">
                <key-value v-if="system.app.version" name="<%= __('Version') %>" :value="system.app.version"></key-value>
                <key-value v-if="system.app.uptime" name="<%= __('Uptime') %>" :value="system.app.uptime | durationSeconds"></key-value>
            </div>
        </div>
    </div>
    <div class="col-md-6" v-if="system.node">
        <div class="panel panel-default">
            <div class="panel-heading"><b>Node.js</b></div>
            <div class="panel-body">
                <key-value v-if="system.node.version" name="<%= __('Version') %>" :value="system.node.version"></key-value>
            </div>
        </div>
    </div>
</div>
</div>

<script type="text/x-template" id="v-tpl-key-value">
    <div class="key-value">
        <span class="key">{{ name }}</span><span class="value">{{ value }}</span>
    </div>
</script>

<script type="text/javascript">
let sysInfoApp;
$(function () {
    sysInfoApp = new Vue({
        el: '#system-information',
        data: {
            autoRefresher: {
                timer: null,
                delayChoices: [
                    {
                        label: "1s",
                        ms: 1000
                    },
                    {
                        label: "2s",
                        ms: 2000
                    },
                    {
                        label: "5s",
                        ms: 5000
                    },
                    {
                        label: "10s",
                        ms: 10000
                    },
                    {
                        label: "30s",
                        ms: 30000
                    },
                ],
                currentDelay: {
                    label: "5s",
                    ms: 5000
                }
            },
            initialized: false,
            lastUpdateTstamp: null,
            system: {}
        },
        computed: {
            lastUpdateDate: function() {
                if (this.lastUpdateTstamp) {
                    return moment(this.lastUpdateTstamp);
                } else {
                    return moment();
                }
            }
        },
        filters: {
            durationSeconds: function(seconds) {
                return moment.duration(seconds, "seconds").format("<%= __('Y [year(s)] M [month(s)] d [day(s)] h[h] mm[m] ss[s]') %>");
            }
        },
        methods: {
            updateData: function() {
                $.get('/admin/system-information', function (data) {
                    if (data.system) {
                        this.system = data.system;
                        this.initialized = true;
                    }
                    if (data.lastUpdate) {
                        this.lastUpdateTstamp = data.lastUpdate;
                    }
                }.bind(this));
            },
            startAutoRefresh: function(delay) {
                if (this.autoRefresher.timer) {
                    clearInterval(this.autoRefresher.timer);
                }
                delay = delay || this.autoRefresher.currentDelay.ms;
                if (delay === false || delay <= 0) {
                    delay = this.autoRefresher.currentDelay.ms;
                }
                this.autoRefresher.timer = setInterval(function () {
                    this.updateData();
                }.bind(this), delay);
            },
            stopAutoRefresh: function() {
                clearInterval(this.autoRefresher.timer);
                this.autoRefresher.timer = null;
            },
            toggleAutoRefresh: function() {
                if (this.autoRefresher.timer) {
                    this.stopAutoRefresh();
                } else {
                    this.startAutoRefresh(this.autoRefresher.currentDelay.ms);
                }
            },
            setAutoRefreshDelay: function(delay) {
                this.autoRefresher.currentDelay.label = delay.label;
                this.autoRefresher.currentDelay.ms = delay.ms;

                if (this.autoRefresher.timer) {
                    this.startAutoRefresh();
                }
            }
        },
        components: {
            'key-value': {
                template: '#v-tpl-key-value',
                props: ['name', 'value'],
            }
        },
        mounted: function() {
            this.updateData();
            this.toggleAutoRefresh();
        },
        beforeDestroy: function() {
            this.stopAutoRefresh();
        }
    });
});
</script>