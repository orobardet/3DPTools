<h1><i class="p3di p3di-filament"></i>&nbsp;<%- __('Filaments') %></h1>

<div class="panel panel-default">
    <div class="panel-heading with-button">
        <a href="/filament/add" class="btn btn-primary trg-add-filament"><i
                    class="fa fa-plus"></i>&nbsp;<%- __('Add filament') %></a>
        <% if (filaments && filaments.length) { %>
        <h3 class="panel-title"><%- __n("%s filament", "%s filaments", filaments.length || 0); %></h3>
        <% } else { %>
        <%- __('No filament found.') %>
        <% } %>
    </div>
    <% if (filaments && filaments.length) { %>
    <table class="table table-hover filament-list">
        <tr>
            <th></th>
            <th colspan="3"><%- __('Specifications') %></th>
            <th><%- __('Brand') %></th>
            <th><%- __('Material left') %></th>
            <th></th>
        </tr>
        <% filaments.forEach(function (filament) { %>
        <tr class="trg-show-filament" data-url="/filament/show/<%- filament.id %>">
            <td><i title="<%- filament.color.name %>" class="color-preview"
                   style="background-color: <%- filament.color.code %> %>;"></i></td>
            <td>
                <%- filament.material.name %>
                <br/>
                <i class="fa fa-balance-scale"></i>
                <%- __('%s kg', filament.initialMaterialWeight) %>
            </td>
            <td>
                <b>∅</b> <%- filament.diameter %>
                <br/>
                <%- __('%s kg/m³', filament.density) %>
            </td>
            <td>
                <% if (filament.headTemp.experienced) { %>
                <i class="p3di p3di-printer-head-heat"></i>
                <%- __('%s°C', filament.headTemp.experienced) %>
                <% } %>
                <br/>
                <% if (filament.bedTemp.experienced) { %>
                <i class="p3di p3di-printer-bed-heat"></i>
                <%- __('%s°C', filament.bedTemp.experienced) %>
                <% } %>
            </td>
            <td>
                <% if (filament.brand.logo && filament.brand.logo.size) { %>
                <img alt="<%- filament.brand.name %>" title="<%- filament.brand.name %>" class="brand-logo"
                     src="/brand/get-logo/<%- filament.brand.id %>">
                <% } else { %>
                <%- filament.brand.name %>
                <% } %>
            </td>
            <td>
                <div class="progress">
                    <%
                        var leftPercentage = filament.materialLeftPercentage;
                        var progressbarClass = 'progress-bar-success';
                        if (leftPercentage <= config.get('filament:leftThresholds:warning')) {
                            progressbarClass = 'progress-bar-warning'
                        }
                        if (leftPercentage <= config.get('filament:leftThresholds:danger')) {
                            progressbarClass = 'progress-bar-danger'
                        }
                    %>
                    <div title="<%- leftPercentage %>%" class="progress-bar <%- progressbarClass %>"
                         role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                         style="width: <%- leftPercentage %>%;">
                        <%- leftPercentage %>%
                    </div>
                </div>
            </td>

            <td class="table-actions">
                <div class="actions-block">
                    <a href="/filament/show/<%- filament.id %>" class="trg-add-filament"><i class=" fa fa-eye"></i>&nbsp;<%- __("show") %></a>
                    <a href="/filament/edit/<%- filament.id %>" class="trg-edit-filament"><i class=" fa fa-pencil"></i>&nbsp;<%- __("edit") %>
                    </a>
                    <a href="/filament/delete/<%- filament.id %>" data-id="<%- filament.id %>"
                       class="trg-delete-filament"><i class="fa fa-trash"></i>&nbsp;<%- __("delete") %></a>
                    <br/>
                    <a href="/filament/left-material/<%- filament.id %>"><i class="fa fa-balance-scale"></i>&nbsp;<%- __("left material") %></a>
                </div>
            </td>
        </tr>
        <% }); %>
    </table>
    <% } %>
</div>

<div id="filament-message-container"></div>

<script type="text/javascript">
    $(function () {
        function deleteFilament(filamentId) {
            $.ajax({
                type: "DELETE",
                url: '/filament/delete/' + filamentId,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {
                    if (data.message) {
                        App3DPTools.successFlash('#filament-message-container', data.message);
                    }
                    document.location = document.location;
                },
                error: function (xhr, status, errorMsg) {
                    if (xhr.responseJSON) {
                        var data = xhr.responseJSON;
                        if (data.message) {
                            App3DPTools.errorFlash('#filament-message-container', data.message);
                            return;
                        }
                    }
                    App3DPTools.errorFlash('#filament-message-container', errorMsg);
                }
            });
        }

        $('.trg-delete-filament').click(function (e) {
            e.preventDefault();
            e.stopPropagation();

            var $this = $(this);
            var filamentId = $this.data('id');

            $.ajax({
                type: "GET",
                url: '/filament/get/' + filamentId,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {
                    if (data.filament) {
                        App3DPTools.confirmModal(Locale3DPTools.__('Delete %s filament?', data.filament.name), function () {
                            deleteFilament(filamentId);
                        });
                    } else {
                        App3DPTools.errorFlash('#filament-message-container', Locale3DPTools.__('Error while retrieving data for filament %s.', filamentId));
                        return;
                    }
                },
                error: function (xhr, status, errorMsg) {
                    if (xhr.responseJSON) {
                        var data = xhr.responseJSON;
                        if (data.message) {
                            App3DPTools.errorFlash('#filament-message-container', data.message);
                            return;
                        }
                    }
                    App3DPTools.errorFlash('#filament-message-container', errorMsg);
                }
            });
        });

        $('.trg-edit-filament').click(function (e) {
            e.stopPropagation();
            return true;
        });

        $('.trg-show-filament').click(function (e) {
            var url = $(this).data('url');

            if (url) {
                document.location = url;
            }
        });
    });
</script>